{% extends 'layouts/base.html' %}

{% block extrastyle %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  /* Scanner Modal styles */
  .modal {
    position: fixed;
    top: 100px;
    left: 100px;
    width: 720px;
    max-width: 90%;
    background-color: #f2e6b4;
    border: 3px dashed #aa8800;
    border-radius: 10px;
    box-shadow: 0 0 15px #333;
    z-index: 9999;
    display: none; /* hidden by default */
  }

  #scannerHeader {
    cursor: move;
    padding: 12px;
    background-color: #aa8800;
    font-weight: bold;
    color: #2f2f2f;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }

  .modal-content {
    padding: 10px 20px;  /* reduced vertical padding */
    text-align: center;
  }

  .close-btn {
    float: right;
    font-size: 1.5rem;
    cursor: pointer;
    color: #2f2f2f;
  }

  .btn-scan {
    background-color: #aa8800;
    color: black;
    font-weight: bold;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    margin-top: 15px;
    font-size: 1.1rem;
  }

  .btn-scan:hover {
    background-color: #ffcc00;
    transform: scale(1.05);
  }

  /* Canvas for annotated image */
  #annotatedCanvas {
    display: none;
    margin: 10px auto 0 auto;
    max-width: 80%;
    border: 1px solid #ccc;
  }

  /* Inventory Container and related styles */
  .inventory {
    width: 90vw;
    max-width: 1200px;
    height: calc(70vw * 0.667);
    max-height: 700px;
    background: #c6c6c6;
    border-radius: 0.5vw;
    box-shadow: 0.8vw 0.8vw 0 0 #555555, inset 0.67vw 0.67vw 0 0 #fefefe;
    padding-top: 1vw;
    padding-left: 1vw;
    margin-bottom: 2vw;
  }

  h1 {
    margin: 1vw 2vw;
    font-family: 'VT323', monospace;
    font-size: 4vw;
    color: #404040;
  }

  .number {
    font-family: 'VT323', monospace;
    font-size: 2vw;
    color: #fefefe;
    position: relative;
    text-shadow: 0.4vw 0.8vw 0 0 #333;
    top: -2vw;
    right: -0.6vw;
    cursor: default;
  }

  .slotSpace {
    display: flex;
    justify-content: center;
    flex-wrap: nowrap;
    margin: 1vw;
  }

  .slot {
    flex: 0 0 calc(0.85 * ((100% - 2vw) / 10));
    aspect-ratio: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #8b8b8b;
    box-shadow: inset 0.225vw 0.225vw 0 rgba(55,55,55,0.8),
                inset -0.297vw -0.297vw 0 #ffffff;
    margin: 0.45vw;
  }

  .selected {
  outline: 3px solid red;
  outline-offset: -3px;
}

  .last-row {
    border: 0.33vw solid gold;
    padding: 0.5vw;
  }

  .item {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 90%;
    height: 90%;
  }

  .item img {
    width: 90%;
  }

  .ghostItem img {
    width: 90%;
  }

  .ghostItem .number {
    top: -1.33vw;
    right: -0.67vw;
  }

  .copy {
    font-family: 'VT323', monospace;
    font-size: 3vw;
    width: 90%;
    display: flex;
    justify-content: flex-end;
    color: #333;
  }

  a {
    color: inherit;
    text-decoration: inherit;
  }

  .content {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* Open Scanner Button styling */
  .btn-green {
    background-color: #4CAF50;
    color: white;
    font-size: 1.2rem;
    padding: 15px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin: 20px auto;
    display: block;
  }

  .btn-green:hover {
    background-color: #45a049;
  }
</style>
{% endblock extrastyle %}

{% block content %}
<!-- Scanner Modal (hidden by default) -->
<div id="scannerModal" class="modal">
  <div id="scannerHeader">
    üßü‚Äç‚ôÇÔ∏èInventory Scanner <span class="close-btn" onclick="closeScanner()">√ó</span>
  </div>
  <div class="modal-content">
    <!-- Video feed -->
    <video id="camera-stream" autoplay playsinline style="max-width:90%;"></video>
    <!-- Capture button -->
    <button id="capture-btn" class="btn btn-scan">‚ö†Ô∏è Scan Item</button>
    <!-- Annotated output canvas (will be displayed after analysis) -->
    <canvas id="annotatedCanvas"></canvas>
    <button id="addItemsBtn" class="btn-green">Add Items</button>
  </div>

</div>

<!-- JavaScript for Scanner functionality and annotation -->
<script>
  // Helper: Convert a data URL to a Blob
  function dataURLtoBlob(dataURL) {
    const parts = dataURL.split(',');
    const base64 = parts[1];
    const binary = atob(base64);
    let array = [];
    for (let i = 0; i < binary.length; i++) {
      array.push(binary.charCodeAt(i));
    }
    return new Blob([new Uint8Array(array)], { type: 'image/png' });
  }

// Helper: Convert base64 to Image object
// Helper: Convert base64 mask to Image object
function base64ToImage(base64) {
  const img = new Image();
  img.src = base64;
  return img;
}

// Helper: Generate random color
function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

// Helper: Create a colored mask
function applyColoredMask(ctx, maskImg, color, x0, y0, x1, y1) {
  const width = x1 - x0;
  const height = y1 - y0;

  // Off-screen canvas for mask processing
  const offCanvas = document.createElement('canvas');
  offCanvas.width = width;
  offCanvas.height = height;
  const offCtx = offCanvas.getContext('2d');

  // Draw mask onto off-screen canvas
  offCtx.drawImage(maskImg, x0, y0, width, height, 0, 0, width, height);

  // Get mask data
  const maskData = offCtx.getImageData(0, 0, width, height);
  const maskPixels = maskData.data;

  // Get original image data from main canvas
  const originalData = ctx.getImageData(x0, y0, width, height);
  const originalPixels = originalData.data;

  // Convert hex color to RGB
  const rgbColor = hexToRgb(color);


  const transparency=0.4;
  // Apply color ONLY to pixels explicitly marked by the mask (alpha > 0)
  for (let i = 0; i < maskPixels.length; i += 4) {
    if (maskPixels[i + 2] > 0) {
      originalPixels[i] = originalPixels[i]*(1-transparency)+rgbColor.r*transparency;
      originalPixels[i + 1] = originalPixels[i+1]*(1-transparency)+rgbColor.g*transparency;
      originalPixels[i + 2] = originalPixels[i+2]*(1-transparency)+rgbColor.b*transparency;
      originalPixels[i + 3] = 150; // Slight transparency (adjustable)
    }
  }

  // Update main canvas with highlighted pixels
  ctx.putImageData(originalData, x0, y0);
}


// Helper: Convert hex to RGB
function hexToRgb(hex) {
  const bigint = parseInt(hex.substring(1), 16);
  return {
    r: (bigint >> 16) & 255,
    g: (bigint >> 8) & 255,
    b: bigint & 255
  };
}

// Updated annotateImage function
function annotateImage(baseImgDataURL, results) {
  const baseImage = new Image();
  baseImage.onload = () => {
    const canvas = document.getElementById('annotatedCanvas');
    canvas.width = baseImage.width;
    canvas.height = baseImage.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(baseImage, 0, 0);

    results.forEach(item => {
      const y0 = item.box_2d[0];
      const x0 = item.box_2d[1];
      const y1 = item.box_2d[2];
      const x1 = item.box_2d[3];
      const boxWidth = x1 - x0;
      const boxHeight = y1 - y0;

      // Generate random color
      const color = getRandomColor();

      // Draw bounding box
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.strokeRect(x0, y0, boxWidth, boxHeight);

      // Label background
      ctx.fillStyle = color;
      ctx.font = "20px Arial";
      const textWidth = ctx.measureText(item.label).width;
      ctx.fillRect(x0, y0 - 24, textWidth + 8, 24);

      // Label text
      ctx.fillStyle = 'white';
      ctx.fillText(item.label, x0 + 4, y0 - 6);

      // Overlay colored mask
      const maskImg = base64ToImage(item.mask);
      maskImg.onload = () => {
        applyColoredMask(ctx, maskImg, color, x0, y0, x1, y1);
      };
    });

    canvas.style.display = 'block';
  };
  baseImage.src = baseImgDataURL;
}



  // Initialize camera stream and capture functionality for the Inventory Scanner
  window.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('camera-stream');
    const canvasBuffer = document.createElement('canvas');
    const captureBtn = document.getElementById('capture-btn');

    // Set up the camera stream
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        alert("Camera access denied or unavailable.");
        console.error(err);
      });

    // Capture button sends screenshot to backend and annotates the image
    captureBtn.addEventListener('click', async () => {
      // Capture a frame from the video feed
      canvasBuffer.width = video.videoWidth;
      canvasBuffer.height = video.videoHeight;
      const ctx = canvasBuffer.getContext('2d');
      ctx.drawImage(video, 0, 0, canvasBuffer.width, canvasBuffer.height);
      const dataURL = canvasBuffer.toDataURL('image/png');

      // Create a Blob from the data URL
      const blob = dataURLtoBlob(dataURL);
      const formData = new FormData();
      formData.append('image', blob, 'screenshot.png');

      try {
        // Send POST request to backend endpoint for segmentation analysis
        // Send POST request to backend endpoint on port 5001 for segmentation analysis
        const response = await fetch('http://127.0.0.1:5001/analyze/segment_items', {
          method: 'POST',
          body: formData
        });

        const results = await response.json();
        console.log("Segmentation results:", results);
        // Annotate the image using the segmentation results
        annotateImage(dataURL, results);
      } catch (error) {
        console.error("Error analyzing screenshot:", error);
        alert("Error analyzing screenshot");
      }
    });

    // Set up the Open Scanner button event
    const openScannerBtn = document.getElementById('openScannerBtn');
    openScannerBtn.addEventListener('click', () => {
      document.getElementById('scannerModal').style.display = 'block';
    });
  });

  // Function to close the scanner modal
  function closeScanner() {
    document.getElementById('scannerModal').style.display = 'none';
  }

  // Enable draggable functionality for the scanner modal
  dragElement(document.getElementById("scannerModal"));
  function dragElement(elmnt) {
    const header = document.getElementById("scannerHeader");
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    if (header) {
      header.onmousedown = dragMouseDown;
    }
    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  document.addEventListener("DOMContentLoaded", function() {

  const selectedItems = new Set();

  document.querySelectorAll(".item").forEach(item => {
    item.addEventListener("click", function(e) {
      e.stopPropagation();
      item.classList.toggle("selected");

      const itemId = item.id;
      if (selectedItems.has(itemId)) {
        selectedItems.delete(itemId);
      } else {
        selectedItems.add(itemId);
      }
    });
  });

  document.getElementById("addItemsBtn").addEventListener("click", function() {
    console.log("Selected items:", Array.from(selectedItems));
  });

});

</script>

<!-- Minecraft Inventory Content -->
<div class="container">
  <!-- Optional filler above inventory -->
  <div style="margin-bottom: 3vw;">Filler.</div>

  <!-- Minecraft Inventory Section -->
  <section class="inventory-section" style="margin-top: 3vw;">
    <div class="content">
      <div class="inventory">
        <!-- Row 1 (10 slots) -->
        <div class="slotSpace">
          <div id="slot0" class="slot"></div>
          <div id="slot1" class="slot"></div>
          <div id="slot2" class="slot">
            <div class="item" id="wood">
              <img src="{{ url_for('static', filename='assets/images/items/wood.png') }}" alt="wood">
              <div class="number">33</div>
            </div>
          </div>
          <div id="slot3" class="slot"></div>
          <div id="slot4" class="slot"></div>
          <div id="slot5" class="slot"></div>
          <div id="slot6" class="slot">
            <div class="item" id="cobblestone-small">
              <img src="{{ url_for('static', filename='assets/images/items/cobblestone.png') }}" alt="cobblestone">
              <div class="number">3</div>
            </div>
          </div>
          <div id="slot7" class="slot"></div>
          <div id="slot8" class="slot">
            <div class="item" id="cobblestone-large">
              <img src="{{ url_for('static', filename='assets/images/items/cobblestone.png') }}" alt="cobblestone">
              <div class="number">14</div>
            </div>
          </div>
          <div id="slot9" class="slot"></div>
        </div>

        <!-- Row 2 (10 slots) -->
        <div class="slotSpace">
          <div id="slot10" class="slot">
            <div class="item" id="diamond_sword">
              <img src="{{ url_for('static', filename='assets/images/items/diamond-sword.png') }}" alt="diamond sword">
              <div class="number">1</div>
            </div>
          </div>
          <div id="slot11" class="slot">
            <div class="item" id="steak">
              <img src="{{ url_for('static', filename='assets/images/items/steak.png') }}" alt="steak">
              <div class="number">12</div>
            </div>
          </div>
          <div id="slot12" class="slot">
            <div class="item" id="diamond">
              <img src="{{ url_for('static', filename='assets/images/items/diamond.png') }}" alt="diamond">
              <div class="number">33</div>
            </div>
          </div>
          <div id="slot13" class="slot">
            <div class="item" id="golden_apple">
              <img src="{{ url_for('static', filename='assets/images/items/apple.gif') }}" alt="golden apple">
              <div class="number">8</div>
            </div>
          </div>
          <div id="slot14" class="slot">
            <div class="item" id="iron_ingot">
              <img src="{{ url_for('static', filename='assets/images/items/iron.png') }}" alt="iron ingot">
              <div class="number">12</div>
            </div>
          </div>
          <div id="slot15" class="slot">
            <div class="item" id="pic_diamond">
              <img src="{{ url_for('static', filename='assets/images/items/diamond-pickaxe.png') }}" alt="diamond pickaxe">
              <div class="number">1</div>
            </div>
          </div>
          <div id="slot16" class="slot">
            <div class="item" id="cobblestone-extra">
              <img src="{{ url_for('static', filename='assets/images/items/cobblestone.png') }}" alt="cobblestone">
              <div class="number">32</div>
            </div>
          </div>
          <div id="slot17" class="slot"></div>
          <div id="slot18" class="slot"></div>
          <div id="slot19" class="slot"></div>
        </div>

        <!-- Row 3 (10 slots) -->
        <div class="slotSpace">
          <div id="slot20" class="slot"></div>
          <div id="slot21" class="slot"></div>
          <div id="slot22" class="slot"></div>
          <div id="slot23" class="slot"></div>
          <div id="slot24" class="slot"></div>
          <div id="slot25" class="slot"></div>
          <div id="slot26" class="slot"></div>
          <div id="slot27" class="slot"></div>
          <div id="slot28" class="slot"></div>
          <div id="slot29" class="slot"></div>
        </div>

        <!-- Row 4 (10 slots) with a gold border -->
        <div class="slotSpace last-row">
          <div id="slot30" class="slot"></div>
          <div id="slot31" class="slot"></div>
          <div id="slot32" class="slot"></div>
          <div id="slot33" class="slot"></div>
          <div id="slot34" class="slot"></div>
          <div id="slot35" class="slot"></div>
          <div id="slot36" class="slot"></div>
          <div id="slot37" class="slot"></div>
          <div id="slot38" class="slot"></div>
          <div id="slot39" class="slot"></div>
        </div>
      </div>
    </div>
  </section>
  <!-- Open Scanner Button below the inventory/crafting table -->
  <button id="openScannerBtn" class="btn-green">Open Scanner</button>

</div>

<script src="{{ url_for('static', filename='assets/js/pages/minecraftInventory.js') }}"></script>
{% endblock %}
